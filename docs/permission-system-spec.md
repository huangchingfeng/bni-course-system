# 權限管理系統規格書

> 版本：v1.0
> 日期：2026-02-03
> 狀態：待確認

---

## 1. 目標

建立分層權限系統，讓不同角色的使用者只能看到/操作其權限範圍內的資料。

---

## 2. 角色與權限矩陣

### 2.1 角色層級（由高到低）

| 層級 | 角色代碼 | 角色名稱 | 資料範圍 | 操作權限 |
|------|----------|----------|----------|----------|
| 1 | `ADMIN` | 管理員 | 全部 | 完整 CRUD |
| 2 | `EXECUTIVE_DIRECTOR` | 執行董事 | 全部 | 查看 |
| 2 | `REGIONAL_DIRECTOR` | 區域董事 | 全部 | 查看 |
| 3 | `DIRECTOR_CONSULTANT` | 董事顧問 | 負責的分會 | 查看 |
| 3 | `AMBASSADOR` | 大使 | 負責的分會 | 查看 |
| 4 | `MENTOR_COORDINATOR` | 導師協調員 | 所屬分會 | 查看 |
| 4 | `EVENT_COORDINATOR` | 活動協調員 | 所屬分會 | 查看 |
| 5 | `MEMBER` | 一般會員 | 自己 | 僅前台 |

### 2.2 詳細權限說明

#### ADMIN（管理員）
- ✅ 查看所有分會、會員、培訓、報名資料
- ✅ 新增/編輯/刪除課程
- ✅ 新增/編輯/刪除會員
- ✅ 新增/編輯分會
- ✅ **設定其他人的權限**（關鍵功能）
  - 設定董事顧問/大使負責哪些分會
  - 指派協調員給分會

#### EXECUTIVE_DIRECTOR / REGIONAL_DIRECTOR（執行董事/區域董事）
- ✅ 查看所有分會、會員、培訓、報名資料
- ✅ 點擊培訓 → 查看報名名單（按分會分組）
- ✅ 點擊會員 → 查看參訓紀錄
- ✅ 查看統計報表
- ❌ 不能新增/編輯資料

#### DIRECTOR_CONSULTANT / AMBASSADOR（董事顧問/大使）
- ✅ 查看**負責分會**的會員
- ✅ 查看**負責分會會員**的報名紀錄
- ✅ 點擊培訓 → 只看到負責分會的報名名單
- ✅ 點擊會員 → 查看該會員參訓紀錄（限負責分會會員）
- ❌ 看不到其他分會的資料
- ❌ 不能新增/編輯資料

#### MENTOR_COORDINATOR / EVENT_COORDINATOR（導師協調員/活動協調員）
- ✅ 查看**所屬分會**的會員
- ✅ 查看**所屬分會會員**的報名紀錄
- ✅ 點擊培訓 → 只看到自己分會的報名名單
- ❌ 看不到其他分會的資料
- ❌ 不能新增/編輯資料

#### MEMBER（一般會員）
- ⛔ 不進後台
- 前台功能：查看課程、報名、查看自己的報名紀錄

---

## 3. 資料庫變更

### 3.1 修改 Role Enum

```prisma
enum Role {
  MEMBER
  MENTOR_COORDINATOR      // 新增
  EVENT_COORDINATOR       // 新增
  CHAPTER_LEADER          // 保留（未來可棄用）
  AMBASSADOR
  DIRECTOR_CONSULTANT
  REGIONAL_DIRECTOR
  EXECUTIVE_DIRECTOR
  ADMIN
}
```

### 3.2 會員-分會關聯（現有）

目前已有 `MemberChapter` 多對多關聯表，用於董事顧問/大使負責多個分會：

```prisma
model MemberChapter {
  memberId  String
  chapterId String
  member    Member  @relation(fields: [memberId], references: [id])
  chapter   Chapter @relation(fields: [chapterId], references: [id])

  @@id([memberId, chapterId])
}
```

### 3.3 需要的關聯

| 角色 | 分會關聯 |
|------|----------|
| MENTOR_COORDINATOR | 使用 `member.chapterId`（所屬分會） |
| EVENT_COORDINATOR | 使用 `member.chapterId`（所屬分會） |
| DIRECTOR_CONSULTANT | 使用 `MemberChapter` 多對多（負責分會） |
| AMBASSADOR | 使用 `MemberChapter` 多對多（負責分會） |

---

## 4. 後台頁面變更

### 4.1 新增：權限管理頁面 `/admin/permissions`

**只有 ADMIN 可見**

#### 4.1.1 頁面佈局

```
┌─────────────────────────────────────────────────────────────────┐
│  權限管理                                        [+ 新增管理員] │
├─────────────────────────────────────────────────────────────────┤
│  🔍 搜尋會員...          [角色篩選 ▼]                          │
├─────────────────────────────────────────────────────────────────┤
│  姓名        │ Email           │ 角色       │ 負責分會   │ 操作│
│─────────────────────────────────────────────────────────────────│
│  王大明      │ wang@email.com  │ 執行董事   │ 全部       │ [編輯]│
│  李小華      │ lee@email.com   │ 董事顧問   │ 華榮、華億 │ [編輯]│
│  張美玲      │ zhang@email.com │ 大使       │ 華日、華One│ [編輯]│
│  陳志明      │ chen@email.com  │ 導師協調員 │ 華榮       │ [編輯]│
└─────────────────────────────────────────────────────────────────┘
```

#### 4.1.2 ADMIN 可執行的操作

| 操作 | 說明 |
|------|------|
| **新增管理員** | 將現有會員升級為管理角色 |
| **編輯角色** | 變更任何人的角色（執董→董顧、董顧→大使 等） |
| **指派分會** | 設定董顧/大使負責哪些分會（多選） |
| **指派協調員** | 設定分會的導師協調員/活動協調員 |
| **移除權限** | 將管理角色降為一般會員 |

#### 4.1.3 編輯權限彈窗

點擊「編輯」後顯示：

```
┌─────────────────────────────────────────┐
│  編輯權限 - 李小華                      │
├─────────────────────────────────────────┤
│  目前角色：董事顧問                     │
│                                         │
│  變更角色：                             │
│  ┌─────────────────────────────────┐   │
│  │ ○ 一般會員                      │   │
│  │ ○ 導師協調員                    │   │
│  │ ○ 活動協調員                    │   │
│  │ ○ 大使                          │   │
│  │ ● 董事顧問 ← 目前               │   │
│  │ ○ 區域董事                      │   │
│  │ ○ 執行董事                      │   │
│  │ ○ 管理員                        │   │
│  └─────────────────────────────────┘   │
│                                         │
│  負責分會：（董顧/大使適用）            │
│  ┌─────────────────────────────────┐   │
│  │ ☑ 華榮分會                      │   │
│  │ ☑ 華億分會                      │   │
│  │ ☐ 華日分會                      │   │
│  │ ☐ 華One分會                     │   │
│  │ ☐ ...（其他分會）               │   │
│  └─────────────────────────────────┘   │
│                                         │
│           [取消]  [儲存變更]            │
└─────────────────────────────────────────┘
```

#### 4.1.4 分會協調員管理

另一個 Tab 或區塊：

```
┌─────────────────────────────────────────────────────────────────┐
│  分會協調員管理                                                 │
├─────────────────────────────────────────────────────────────────┤
│  分會      │ 導師協調員      │ 活動協調員      │ 操作          │
│─────────────────────────────────────────────────────────────────│
│  華榮分會  │ 陳志明          │ 林美華          │ [編輯]        │
│  華億分會  │ 未指派          │ 王小明          │ [編輯]        │
│  華日分會  │ 張大偉          │ 未指派          │ [編輯]        │
└─────────────────────────────────────────────────────────────────┘
```

點擊編輯後，可從該分會的會員中選擇指派協調員。

### 4.2 修改：現有頁面的權限過濾

#### 培訓管理 `/admin/training`
- 執董/區董：看全部
- 董事顧問/大使：只顯示「負責分會有人報名」的培訓
- 協調員：只顯示「自己分會有人報名」的培訓

#### 培訓詳情 `/admin/training/[id]`
- 執董/區董：看全部報名名單
- 董事顧問/大使：只顯示負責分會的報名者
- 協調員：只顯示自己分會的報名者

#### 會員管理 `/admin/members`
- 執董/區董：看全部會員
- 董事顧問/大使：只顯示負責分會的會員
- 協調員：只顯示自己分會的會員

#### 會員詳情 `/admin/members/[id]`
- 顯示該會員的參訓紀錄
- 根據權限過濾可見的會員

#### 統計報表 `/admin/stats`
- 執董/區董：看全部統計
- 董事顧問/大使：只顯示負責分會的統計
- 協調員：只顯示自己分會的統計

### 4.3 側邊欄選單調整

| 選單項目 | ADMIN | 執董/區董 | 董顧/大使 | 協調員 |
|----------|-------|-----------|-----------|--------|
| 儀表板 | ✅ | ✅ | ✅ | ✅ |
| 課程管理 | ✅ | ❌ | ❌ | ❌ |
| 培訓管理 | ✅ | ✅ | ✅ | ✅ |
| 會員管理 | ✅ | ✅ | ✅ | ✅ |
| 分會管理 | ✅ | ❌ | ❌ | ❌ |
| 統計報表 | ✅ | ✅ | ✅ | ✅ |
| 權限管理 | ✅ | ❌ | ❌ | ❌ |

---

## 5. API 變更

### 5.1 權限中介層

建立 `lib/permissions.ts` 擴充：

```typescript
// 取得使用者可見的分會 ID 列表
function getAccessibleChapterIds(user: User): string[] | 'all'

// 檢查使用者是否可見特定會員
function canViewMember(user: User, memberId: string): boolean

// 檢查使用者是否可見特定培訓的報名名單
function canViewRegistrations(user: User, courseId: string): boolean
```

### 5.2 API 路由修改

| API | 變更 |
|-----|------|
| `GET /api/members` | 加入分會過濾 |
| `GET /api/members/[id]` | 檢查權限 |
| `GET /api/registrations` | 加入分會過濾 |
| `GET /api/chapters` | 根據權限過濾 |
| `POST /api/permissions` | 新增：設定權限 |

---

## 6. 使用者情境

### 情境 1：ADMIN 設定董事顧問權限
1. 進入「權限管理」
2. 找到某位董事顧問
3. 勾選他負責的分會（例：華榮、華億、華日）
4. 儲存

### 情境 2：董事顧問查看培訓報名
1. 登入後進入「培訓管理」
2. 只看到「華榮、華億、華日有人報名」的培訓
3. 點擊某場培訓
4. 只看到這三個分會的報名名單

### 情境 3：董事顧問查看會員參訓紀錄
1. 進入「會員管理」
2. 只看到華榮、華億、華日的會員
3. 點擊某位會員
4. 看到該會員的所有參訓紀錄

### 情境 4：導師協調員查看分會參與狀況
1. 登入後進入「培訓管理」
2. 只看到「自己分會有人報名」的培訓
3. 點擊某場培訓
4. 只看到自己分會的報名名單

---

## 7. 實作優先順序

### Phase 1：核心權限過濾
1. 新增角色 Enum
2. 建立權限判斷函式
3. 修改 API 加入過濾
4. 修改培訓管理頁面
5. 修改會員管理頁面

### Phase 2：權限管理介面
1. 建立權限管理頁面
2. 會員角色編輯
3. 分會負責人設定
4. 協調員指派

### Phase 3：優化與測試
1. 儀表板根據權限顯示
2. 統計報表過濾
3. 完整測試各角色權限

---

## 8. 已確認事項

- [x] 執董/區董：**只能查看**，不能編輯
- [x] 會員前台：**可以看到自己的參訓紀錄**
- [x] 操作日誌：**需要**，記錄所有新增/編輯/刪除操作

---

## 9. 操作日誌系統

### 9.1 日誌資料表

```prisma
model AuditLog {
  id          String   @id @default(cuid())
  userId      String                    // 操作者 ID
  userEmail   String                    // 操作者 Email
  action      AuditAction               // 操作類型
  targetType  String                    // 目標類型 (Member, Course, Registration, etc.)
  targetId    String                    // 目標 ID
  targetName  String?                   // 目標名稱（方便閱讀）
  changes     Json?                     // 變更內容（舊值 → 新值）
  ipAddress   String?                   // IP 位址
  createdAt   DateTime @default(now())

  user        Member   @relation(fields: [userId], references: [id])
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  PERMISSION_CHANGE
}
```

### 9.2 記錄的操作

| 操作類型 | 記錄內容 |
|----------|----------|
| 新增會員 | 誰新增了誰，填了什麼資料 |
| 編輯會員 | 誰改了誰，改了什麼欄位 |
| 刪除會員 | 誰刪了誰 |
| 新增課程 | 誰建了什麼課程 |
| 編輯課程 | 誰改了什麼課程 |
| 報名/取消報名 | 誰幫誰報名/取消 |
| **權限變更** | 誰把誰的角色改成什麼、負責分會改成什麼 |
| 登入/登出 | 誰在什麼時候登入 |

### 9.3 日誌查看頁面 `/admin/logs`

- 只有 **ADMIN** 可見
- 顯示：時間、操作者、動作、目標、詳情
- 支援：
  - 依日期範圍篩選
  - 依操作者篩選
  - 依操作類型篩選

---

## 10. 前台參訓紀錄

### 10.1 修改「我的報名」頁面 `/my`

新增區塊：**參訓紀錄**

顯示：
- 已參加過的培訓列表
- 每場培訓：名稱、日期、類型
- 統計：總共參加 X 場培訓

```
┌─────────────────────────────────────────┐
│  我的報名                               │
├─────────────────────────────────────────┤
│  📅 即將參加                            │
│  ┌─────────────────────────────────────┐│
│  │ MSP 會員成功培訓計畫                ││
│  │ 2026/02/15 (六) 09:00-17:00        ││
│  │ [取消報名]                          ││
│  └─────────────────────────────────────┘│
├─────────────────────────────────────────┤
│  📜 參訓紀錄（共 5 場）                 │
│  ┌─────────────────────────────────────┐│
│  │ ✓ PT 工作坊 - 2026/01/20           ││
│  │ ✓ 引薦工作坊 - 2025/12/15          ││
│  │ ✓ MSP - 2025/11/10                 ││
│  │ ...                                 ││
│  └─────────────────────────────────────┘│
└─────────────────────────────────────────┘
```

---

## 11. 附錄：現有角色對照

| 原有角色 | 新系統處理 |
|----------|------------|
| MEMBER | 保持不變 |
| CHAPTER_LEADER | 保留，但建議改用 MENTOR/EVENT_COORDINATOR |
| AMBASSADOR | 保持，加入分會過濾 |
| DIRECTOR_CONSULTANT | 保持，加入分會過濾 |
| REGIONAL_DIRECTOR | 保持，可見全部 |
| EXECUTIVE_DIRECTOR | 保持，可見全部 |
| ADMIN | 保持，完整權限 |

---

## 12. 實作計畫

### Phase 1：資料庫與核心（預估 1-2 天）
- [ ] 新增 Role Enum（MENTOR_COORDINATOR, EVENT_COORDINATOR）
- [ ] 新增 AuditLog 資料表
- [ ] 建立權限判斷函式 `lib/permissions.ts`
- [ ] 建立日誌記錄函式 `lib/audit.ts`

### Phase 2：API 過濾（預估 1-2 天）
- [ ] 修改 `/api/members` 加入分會過濾
- [ ] 修改 `/api/registrations` 加入分會過濾
- [ ] 新增 `/api/permissions` 權限設定 API
- [ ] 新增 `/api/logs` 日誌查詢 API

### Phase 3：後台頁面（預估 2-3 天）
- [ ] 新增「權限管理」頁面 `/admin/permissions`
- [ ] 新增「操作日誌」頁面 `/admin/logs`
- [ ] 修改「培訓管理」頁面（權限過濾）
- [ ] 修改「會員管理」頁面（權限過濾）
- [ ] 修改「統計報表」頁面（權限過濾）
- [ ] 修改側邊欄（根據角色顯示選單）

### Phase 4：前台與測試（預估 1 天）
- [ ] 修改「我的報名」頁面（加入參訓紀錄）
- [ ] 測試各角色權限
- [ ] 修復問題

---

## 13. 文件歷程

| 版本 | 日期 | 變更 |
|------|------|------|
| v1.0 | 2026-02-03 | 初版建立 |
| v1.1 | 2026-02-03 | 確認執董權限、加入操作日誌、前台參訓紀錄 |
